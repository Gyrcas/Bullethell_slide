[gd_scene load_steps=6 format=3 uid="uid://ch0xv1s53qf6m"]

[ext_resource type="Texture2D" uid="uid://dy3d5ewu7q0xu" path="res://New Piskel.png" id="3_5o0qe"]
[ext_resource type="PackedScene" uid="uid://pa4b5sl2ju1n" path="res://entities/player.tscn" id="4_nr1bs"]
[ext_resource type="Texture2D" uid="uid://dcd0o2gh4toex" path="res://star.png" id="4_pvx28"]

[sub_resource type="ArrayMesh" id="ArrayMesh_62w4p"]
_surfaces = [{
"2d": true,
"aabb": AABB(-100, -100, 0, 200, 200, 0),
"attribute_data": PackedByteArray(0, 0, 128, 63, 0, 0, 128, 63, 0, 0, 0, 0, 0, 0, 128, 63, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128, 63, 0, 0, 0, 0),
"format": 33558545,
"index_count": 6,
"index_data": PackedByteArray(3, 0, 0, 0, 1, 0, 1, 0, 2, 0, 3, 0),
"primitive": 3,
"vertex_count": 4,
"vertex_data": PackedByteArray(0, 0, 200, 66, 0, 0, 200, 66, 0, 0, 200, 194, 0, 0, 200, 66, 0, 0, 200, 194, 0, 0, 200, 194, 0, 0, 200, 66, 0, 0, 200, 194)
}]

[sub_resource type="GDScript" id="GDScript_htoo4"]
script/source = "extends Node2D


@export var texture : Texture2D

signal continue_gen

func generate():
	UT.remove_children(self)
	var bitmap : BitMap = BitMap.new()
	await continue_gen
	bitmap.create_from_image_alpha(texture.get_image())
	await continue_gen
	var pols : Array[PackedVector2Array] = bitmap.opaque_to_polygons(Rect2i(Vector2.ZERO,texture.get_size()),20)
	await continue_gen
	for pol in pols:
		await continue_gen
		var static_bod = StaticBody2D.new()
		var col = CollisionPolygon2D.new()
		col.polygon = pol
		print(pol.size())
		static_bod.add_child(col)
		add_child.call_deferred(static_bod)


func _ready():
	var sprite = Sprite2D.new()
	sprite.texture = texture
	sprite.centered = false
	add_child.call_deferred(sprite)
	generate()

var t = 0
var b = true

func _process(delta):
	var bitmap : BitMap = BitMap.new()
	bitmap.create_from_image_alpha(texture.get_image())
	var pols : Array[PackedVector2Array] = bitmap.opaque_to_polygons(Rect2i(Vector2.ZERO,texture.get_size()))
	continue_gen.emit()
	print(t)
	t += delta
	if t > 2:
		t = 0
		generate()
			
"

[node name="test" type="Node2D"]
position = Vector2(0, 1)

[node name="Sprite2D" type="MeshInstance2D" parent="."]
visible = false
mesh = SubResource("ArrayMesh_62w4p")
texture = ExtResource("4_pvx28")

[node name="player" parent="." instance=ExtResource("4_nr1bs")]
position = Vector2(-425, 247)

[node name="Node2D" type="Node2D" parent="."]
script = SubResource("GDScript_htoo4")
texture = ExtResource("3_5o0qe")
